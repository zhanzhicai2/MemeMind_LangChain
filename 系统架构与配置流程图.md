# 🏗️ MemeMind 系统架构与配置流程图

## 📋 **系统整体架构图**

```mermaid
graph TB
    %% 用户接口层
    subgraph "用户接口层"
        UI[Gradio Web界面]
        API[FastAPI REST接口]
    end

    %% 业务逻辑层
    subgraph "业务逻辑层"
        DocService[文档服务 Service]
        QueryService[查询服务 Service]
        CeleryTask[异步任务处理]
    end

    %% 数据访问层
    subgraph "数据访问层"
        DocRepo[文档Repository]
        ChunkRepo[文本块Repository]
    end

    %% 数据存储层
    subgraph "数据存储层"
        PG[(PostgreSQL)]
        MinIO[(MinIO对象存储)]
        Chroma[(ChromaDB向量库)]
    end

    %% 消息队列
    subgraph "消息队列"
        RabbitMQ[(RabbitMQ)]
        Redis[(Redis缓存)]
    end

    %% AI模型层
    subgraph "AI模型层"
        Embedding[嵌入模型]
        Reranker[重排模型]
        LLM[大语言模型]
    end

    %% 连接关系
    UI --> API
    API --> DocService
    API --> QueryService
    DocService --> DocRepo
    QueryService --> ChunkRepo
    DocRepo --> PG
    ChunkRepo --> PG
    DocService --> MinIO
    DocService --> CeleryTask
    CeleryTask --> RabbitMQ
    CeleryTask --> Chroma
    CeleryTask --> Embedding
    QueryService --> Chroma
    QueryService --> Reranker
    QueryService --> LLM
    Redis --> API
    Redis --> CeleryTask
```

## ⚙️ **配置参数流转图**

```mermaid
flowchart TD
    Config[config.py 配置中心] -->|读取配置| App[FastAPI应用启动]

    %% 数据库配置流转
    Config -->|POSTGRES_*| PG_Init[数据库初始化]
    PG_Init -->|创建连接池| DB_Session[数据库会话]
    DB_Session -->|CRUD操作| Doc_Repo[文档Repository]
    DB_Session -->|CRUD操作| Chunk_Repo[文本块Repository]

    %% 对象存储配置流转
    Config -->|MINIO_*| S3_Client[S3客户端]
    S3_Client -->|文件上传下载| Doc_Service[文档服务]
    Doc_Service -->|存储文件| MinIO_Bucket[MinIO存储桶]

    %% 向量数据库配置流转
    Config -->|CHROMA_*| Chroma_Client[ChromaDB客户端]
    Chroma_Client -->|向量存储| Vector_Store[向量存储]
    Vector_Store -->|HNSW索引| Chroma_Collection[Chroma集合]

    %% 消息队列配置流转
    Config -->|RABBITMQ_*| Celery_App[Celery应用]
    Celery_App -->|任务队列| RabbitMQ_Broker[RabbitMQ代理]
    Config -->|REDIS_*| Redis_Backend[Redis后端]
    Redis_Backend -->|任务结果存储| Task_Results[任务结果]

    %% AI模型配置流转
    Config -->|EMBEDDING_*| Embedding_Model[嵌入模型]
    Config -->|RERANKER_*| Reranker_Model[重排模型]
    Config -->|LLM_MODEL_PATH| LLM_Model[大语言模型]

    %% 文本处理配置流转
    Config -->|CHUNK_SIZE| Text_Splitter[文本分割器]
    Config -->|CHUNK_OVERLAP| Text_Splitter
    Config -->|INITIAL_RETRIEVAL_TOP_K| Retrieval_Service[检索服务]
    Config -->|FINAL_CONTEXT_TOP_N| Retrieval_Service
```

## 🔍 **详细配置使用场景分析**

### 1️⃣ **数据库配置流程**
```mermaid
sequenceDiagram
    participant Config as config.py
    participant DB as 数据库模块
    participant Service as 服务层
    participant Repo as Repository层

    Config->>DB: 加载POSTGRES配置
    DB->>DB: 创建连接池
    Service->>Repo: 请求数据库会话
    Repo->>DB: 获取连接
    DB-->>Repo: 返回连接
    Repo->>DB: 执行SQL操作
    DB-->>Repo: 返回结果
    Repo-->>Service: 返回ORM对象
```

### 2️⃣ **文档处理配置流程**
```mermaid
sequenceDiagram
    participant Config as config.py
    participant User as 用户上传
    participant S3 as MinIO/S3
    participant Celery as Celery任务
    participant Embedding as 嵌入模型
    participant Chroma as ChromaDB

    User->>Config: 上传文档
    Config->>S3: 使用MINIO配置存储
    S3-->>Config: 返回存储信息
    Config->>Celery: 创建异步任务
    Celery->>Embedding: 使用EMBEDDING_*配置
    Embedding->>Chroma: 使用CHROMA_*配置存储向量
    Chroma-->>Celery: 返回存储结果
```

### 3️⃣ **RAG查询配置流程**
```mermaid
sequenceDiagram
    participant User as 用户查询
    participant Config as config.py
    participant Retrieval as 检索服务
    participant Reranker as 重排模型
    participant LLM as 大语言模型

    User->>Retrieval: 发送查询
    Retrieval->>Config: 使用INITIAL_RETRIEVAL_TOP_K
    Retrieval->>Config: 使用CHROMA_*配置查询向量
    Retrieval->>Reranker: 使用RERANKER_*配置重排
    Reranker->>Config: 使用FINAL_CONTEXT_TOP_N
    Reranker->>LLM: 使用LLM_MODEL_PATH
    LLM-->>User: 返回回答
```

## 📊 **配置参数依赖关系表**

| 配置项 | 使用模块 | 依赖关系 | 影响范围 |
|--------|----------|----------|----------|
| `POSTGRES_*` | `database.py`, `*.py` | 数据库连接 | 全局数据持久化 |
| `MINIO_*` | `s3_client.py` | 对象存储 | 文件上传下载 |
| `CHROMA_*` | `chromadb_client.py` | 向量数据库 | RAG检索 |
| `RABBITMQ_*` | `celery_app.py` | 消息队列 | 异步任务 |
| `REDIS_*` | `celery_app.py` | 结果缓存 | 任务结果存储 |
| `EMBEDDING_*` | `embedding_qwen.py` | 嵌入模型 | 向量生成 |
| `RERANKER_*` | `reranker_qwen.py` | 重排模型 | 结果精排 |
| `LLM_MODEL_PATH` | `llm_qwen.py` | 语言模型 | 答案生成 |
| `CHUNK_SIZE` | `doc_process.py` | 文本分割 | 文档处理 |
| `CHUNK_OVERLAP` | `doc_process.py` | 文本重叠 | 文档处理 |
| `INITIAL_RETRIEVAL_TOP_K` | `query_service.py` | 初始召回 | RAG检索 |
| `FINAL_CONTEXT_TOP_N` | `query_service.py` | 最终上下文 | RAG检索 |

## 🔄 **数据流转详细图**

```mermaid
flowchart LR
    subgraph "配置初始化"
        A1[config.py] --> A2[settings实例化]
        A2 --> A3[各模块导入配置]
    end

    subgraph "文档上传流程"
        B1[用户上传] --> B2[MINIO配置验证]
        B2 --> B3[MinIO存储]
        B3 --> B4[PostgreSQL记录]
        B4 --> B5[Celery异步处理]
    end

    subgraph "文档处理流程"
        C1[Celery任务] --> C2[下载MinIO文件]
        C2 --> C3[文本解析]
        C3 --> C4[CHUNK_SIZE分割]
        C4 --> C5[EMBEDDING模型向量化]
        C5 --> C6[CHROMA数据库存储]
        C6 --> C7[更新处理状态]
    end

    subgraph "RAG查询流程"
        D1[用户查询] --> D2[查询向量化]
        D2 --> D3[CHROMA向量检索]
        D3 --> D4[INITIAL_RETRIEVAL_TOP_K召回]
        D4 --> D5[RERANKER重排]
        D5 --> D6[FINAL_CONTEXT_TOP_N筛选]
        D6 --> D7[LLM生成答案]
    end

    A3 --> B2
    A3 --> C2
    A3 --> C5
    A3 --> D3
    A3 --> D5
    A3 --> D7
```

## 🎯 **配置优化建议**

### 1️⃣ **性能相关配置**
```python
# 文本处理优化
CHUNK_SIZE: int = 1024  # 增大块大小，减少总块数
CHUNK_OVERLAP: int = 100  # 适当重叠，保持上下文

# 检索优化
INITIAL_RETRIEVAL_TOP_K: int = 50  # 初始召回数量
FINAL_CONTEXT_TOP_N: int = 5      # 最终上下文数量

# 内存优化
EMBEDDING_BATCH_SIZE: int = 20    # 嵌入模型批处理大小
```

### 2️⃣ **资源配置建议**
- **PostgreSQL**: 根据文档数量调整连接池大小
- **MinIO**: 确保存储空间充足，设置合适的访问策略
- **ChromaDB**: 监控向量索引大小，适时优化HNSW参数
- **RabbitMQ**: 根据任务量调整队列配置
- **Redis**: 设置合理的过期时间，避免内存溢出

### 3️⃣ **监控配置**
- 添加配置参数验证
- 实现配置热重载
- 设置资源使用监控
- 配置错误告警机制

这个流程图展示了整个MemeMind系统的架构和配置流转关系，帮助你更好地理解各个组件之间的交互和配置参数的使用场景。